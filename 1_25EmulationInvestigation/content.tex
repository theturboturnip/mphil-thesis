\chapter{Hardware emulation investigation}
% In order to experiment with integrating CHERI and RVV, we implemented a RISC-V emulator in the Rust programming language named \enquote{riscv-v-lite}.
% This emulator can emulate three RISC-V ISAs: 
% \begin{itemize}
%     \item \code{rv32imv} - 32-bit + Multiply and Vector extensions
%     \item \code{rv64imv} - 64-bit + Multiply and Vector extensions
%     \item \code{rv64imvxcheri} - 64-bit + CHERI, Multiply, and Vector extensions
% \end{itemize}
% Each ISA's vector behaviour is tested with a set of \code{memcpy}-esque testbench programs.
% These are written in C, using RISC-V vector intrinsics where possible, and compiled with a variety of C compilers to examine compatibility.
% An experimental capabilities-in-vectors concept is also tested.

% \cref{chap:software:sec:emu} describes the emulator, focusing on how vector instructions are emulated.
% \cref{chap:software:sec:testbench} describes the testbench, the various techniques used to emit vector instructions on different compilers, and the results of each testbench for each architecture and compiler.
% \cref{chap:software:sec:capinvec} explains the experiments done with capabilities-in-vectors.

\todomark{introduction}

\section{Developing the emulator}\label{chap:software:sec:emu}
Rust was selected due to its memory safety and runtime speed, and provides language constructs that suit themselves well to emulation.
Rust Enums are equivalent to \enquote{variant} types in other languages like C++, which \todomark{}.
\todomark{something something match statements}.

\subsection{Basic emulation}
The emulator for each architecture follows a similar pattern.
A \code{Processor} struct stores the register file and the available RAM.
A separate \code{ProcessorModules} struct holds all ISA modules the processor can execute (e.g. the base RV64 Integer ISA, the Multiply extension, and the Vector extension).

The gap between the \code{Processor} and the ISA modules is bridged by a module-specific ``connector'' struct, which holds references to data in the \code{Processor} that is required by the ISA module.
For example, the RV64 Integer ISA's connector contains the current PC, a virtual reference to a register file, and a virtual reference to memory.
This allows different \code{Processor} structs (e.g. a normal RV64 and a CHERI-enabled RV64) to reuse the same ISA modules despite using different register file implementations.

Each \code{Processor} implements a single stage pipeline.
Instructions are fetched, decoded with a common decoder function\footnote{The decoder, and therefore all emulated processors, doesn't support RISC-V Compressed instructions.}, and executed.
The processor asks each ISA module in turn if it wants to handle the instruction, and uses the first module to say yes.
If the ISA module returns a new PC value it is immediately applied, otherwise it is automatically incremented.
This structure easily represents basic RISC-V architectures, and can scale up to support many different new modules.

\todomark{What did the emulator set out to emulate? i.e. no supervisor, pure-capability code only}

\input{1_25EmulationInvestigation/sub10_emu_cheri}
\input{1_25EmulationInvestigation/sub20_emu_vec}
\input{1_25EmulationInvestigation/sub30_fast_path}

\section{Going beyond the emulator}
The emulator is a single example of a conformant CHERI-RVV implementation, and does not exercise every part of the specification.
Two properties stand out:
\begin{itemize}
    \item Segments/elements are always accessed in order, despite the spec not enforcing ordering
    \item Imprecise traps are used for all exceptions - precise exception behaviour is not explored.
\end{itemize}
This section notes how relaxed access ordering and precise exceptions may affect the hardware in ways not previously explored.

\subsection{Precise exceptions}
\todomark{precise exceptions}

\subsection{Relaxed access ordering}
\todomark{relaxed access ordering}

\todomark{This section should have bits for atomicity?}
\todomark{This section should have bits for alignment}

\input{1_25EmulationInvestigation/sub50_hyp}

\todomark{where to note that capability checks count as a synchronous exception? centralized point for "here are the differences between RVV and CHERI-RVV?}