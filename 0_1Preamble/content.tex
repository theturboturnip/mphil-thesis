%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Some custom packages
%%
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{xspace}

\usepackage{turniptodo}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Math operators
\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Fonts (like different typewriter fonts etc.)
%%
%\RequirePackage[scaled=.87]{couriers}
%\RequirePackage[T1]{fontenc}
%\renewcommand\rmdefault{psb}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Overwrite section numbering style - don't number subsubsections
%% cam-thesis.cls uses 3 for both, so this code should go there, but I haven't investigated the guidelines to see if it's ok
% \setcounter{secnumdepth}{2} % chapters, sections, subsections numbered
% \setcounter{tocdepth}{2}    % chapters, sections, subsections in TOC
% NOTE - reversed the above because I needed to refer to a sububsection lol

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Style (Changing the visual style of chapter headings and stuff.)
%%
\RequirePackage{titlesec}
% [Fixes issue #34 (see https://github.com/cambridge/thesis/issues/34). Solution from: http://tex.stackexchange.com/questions/299969/titlesec-loss-of-section-numbering-with-the-new-update-2016-03-15
\RequirePackage{etoolbox}
\makeatletter
\patchcmd{\ttlh@hang}{\parindent\z@}{\parindent\z@\leavevmode}{}{}
\patchcmd{\ttlh@hang}{\noindent}{}{}{}
\makeatother
% end of issue #34 fix]
\newcommand{\PreContentTitleFormat}{\titleformat{\chapter}[display]{\scshape\Large}
{\Large\filleft\MakeUppercase{\chaptertitlename} \Huge\thechapter}
{1ex}
{}
[\vspace{1ex}\titlerule]}
\newcommand{\ContentTitleFormat}{\titleformat{\chapter}[display]{\scshape\huge}
{\Large\filleft\MakeUppercase{\chaptertitlename} \Huge\thechapter}
{1ex}
{\titlerule\vspace{1ex}\filright}
[\vspace{1ex}\titlerule]}
\newcommand{\PostContentTitleFormat}{\PreContentTitleFormat}
\PreContentTitleFormat




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% References (special style etc.)
%%
\usepackage{turnipcite}
\bibliography{thesis}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Theorems, definitions, and examples
%%
\RequirePackage{amsthm}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
%% Support for `Examples` (provides a counter for examples, the possibility to
%% label and reference them etc.)
%%
\newtheorem{example}{Example}[chapter]




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Captions: This makes captions of figures use a boldfaced small font. 
%%
\RequirePackage[small,bf]{caption}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Subcaption (note: this must be included after the `caption` package). 
%%
\RequirePackage{subcaption}
\RequirePackage{adjustbox}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% cleverref
%%
\usepackage[capitalize,nameinlink]{cleveref}
% Compatibility with hyperrref
% https://tex.stackexchange.com/a/485979
\usepackage{crossreftools}

\let\ORGhypersetup\hypersetup
\protected\def\hypersetup{\ORGhypersetup}
\pdfstringdefDisableCommands{%
  \def\hypersetup#1{}%
  \let\Cref\crtCref
  \let\cref\crtcref
}


%%%
%% Hypothesis counter and labels
\newcounter{hypI} % hyp counter
\setcounter{hypI}{0}
% Representation of hyp counter: H-<hypI>
\renewcommand{\thehypI}{H-\arabic{hypI}}
\newcommand{\newhyp}{%
    \refstepcounter{hypI}% Step hypothesis counter
    \thehypI% Print hypothesis counter
}
\crefname{hypI}{Hypothesis}{Hyps.}

\begin{luacode*}
hypothesis_text = {}
function add_hypothesis(code, text)
    hypothesis_text[code] = text
end
function get_hypothesis(code)
    text = hypothesis_text[code]
    if text == nil then
        error("Hypothesis code " + code + " doesn't have associated text")
    end
    return text
end
\end{luacode*}
\newcommand{\sethyptext}[2]{\luadirect{add_hypothesis(\luastring{#1}, \luastring{#2})}}
\newcommand{\gethyptext}[1]{\luadirect{tex.sprint(get_hypothesis(\luastring{#1}))}}

% Arg 1: hypothesis label
% Arg 2: summary
\newcommand{\hypsubsection}[2]{
\subsection*{\cref*{#1} - #2}
\addcontentsline{toc}{subsection}{Hypothesis \ref*{#1} - #2}
\begin{quote}\textit{\gethyptext{#1}}\end{quote}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Content commands
%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Glossary entries
%%
% \newglossaryentry{pi}{
%     name={\ensuremath{\pi}},
%     sort={pi},
%     description={ratio of the circumference of a circle to the diameter}
% }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Custom formatting commands
% \RequirePackage{relsize}
\newcommand{\code}[1]{{\texttt{#1}}}
% parameter to an assembly instruction
\newcommand{\param}[1]{\textbf{\textcolor{Blue}{#1}}}
% Use instead of \param when not inside \code
\newcommand{\paramt}[1]{\code{\param{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Formatting-agnostic figures code

\RequirePackage{pgfkeys}
\RequirePackage{etoolbox}
% Create a pgfkey directory for figinput
\pgfkeys{
 /figinput/.is family, /figinput,
 default/.style = 
  {width = \textwidth, pos = htbp},
 width/.estore in = \figinputWidth,
 pos/.estore in = \figinputPos,
}
% figinput - example \figinput[width=0.7\textwidth,pos=htbp]{fig_RVV_added_state}
% Sets configuration vars, inputs the file in the main argument
% The main argument file should respect the \figinputWidth and \figinputPos variables.
% The \basicfig environment is a simple way to do this for single-graphic figures.
\newcommand{\figinput}[2][]{%
    % Unpack the figure options
    \pgfkeys{/figinput, default, #1}%
    % Input the figure page
    \input{#2}%
    % Zero out the parameters
    % The figure page can check if it's been imported through \figinput by looking at these values
    \renewcommand{\figinputWidth}{}
    \renewcommand{\figinputPos}{}
}

% Assert the pgfkeys are non-empty
\newcommand{\figcheckinputs}{
\ifdefempty{\figinputWidth}{\PackageError{turnipadjfig}{figinputWidth empty}{This file expected arguments from figinput - make sure you include the figure file through figinput!}}{}
\ifdefempty{\figinputPos}{\PackageError{turnipadjfig}{figinputPos empty}{This file expected arguments from figinput - make sure you include the figure file through figinput!}}{}
}

% Example usage:
% \begin{basicfig}{Figures/RVV_LMUL_Widening.pdf}
%     \caption{This is RVV\_LMUL\_widening}
%     \label{fig:RVV_LMUL_widening}
% \end{basicfig}
\newenvironment{basicfig}[1]{%
% Assert the keys are non-empty
\figcheckinputs{}
% Start of environment
% Use \expended to expand the value of \figinputPos in the right place, and put \noexpand at the start to make sure the \begin{figure} itself isn't expanded yet.
\expanded{\noexpand\begin{figure}[\figinputPos]}
    \centering
    \includegraphics[width=\figinputWidth]{#1}
}{%
\end{figure}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Booktabs
\RequirePackage{booktabs}

\usepackage{parnotes}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Lua url encoding
\begin{luacode*}
-- from https://gist.github.com/liukun/f9ce7d6d14fa45fe9b924a3eed5c3d99
char_to_hex = function(c)
    return string.format("%%%02X", string.byte(c))
end

function urlencode(url)
    if url == nil then
        return
    end
    url = url:gsub("\n", "\r\n")
    url = url:gsub("([^%w ])", char_to_hex)
    url = url:gsub(" ", "+")
    return url
end

function print_escaped_url(raw_url)
    -- print start of href tag
    tex.sprint("\\href{")
    -- first argument = percent-encoded raw url
    tex.sprint(urlencode(raw_url))
    -- mid point
    tex.sprint("}{")
    -- second argument = latex-escaped raw url
    -- https://tex.stackexchange.com/a/302129
    tex.print(-2, raw_url)
    tex.sprint("}")
end
\end{luacode*}
\newcommand{\eurl}[1]{\luadirect{print_escaped_url(\luastring{#1})}}